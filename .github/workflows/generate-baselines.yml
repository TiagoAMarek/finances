name: Generate Visual Regression Baselines

# This workflow generates platform-agnostic baseline screenshots for visual regression tests
# and creates a PR with the results. Use this when:
# - Setting up visual tests for the first time
# - After intentional UI changes that affect multiple pages
# - When baselines need to be regenerated
#
# Note: Generates Chromium-only baselines that work on all platforms (macOS, Linux, Windows)
# using pixel difference thresholds to handle font rendering variations.

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to generate baselines for'
        required: true
        default: 'main'

jobs:
  generate-baselines:
    name: Generate Baseline Screenshots
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify MSW worker exists
        run: |
          if [ ! -f "public/mockServiceWorker.js" ]; then
            echo "âŒ MSW worker not found, generating..."
            pnpm exec msw init public/ --save
            echo "âœ… MSW worker generated"
          else
            echo "âœ… MSW worker found ($(du -h public/mockServiceWorker.js | cut -f1))"
          fi

      - name: Install Playwright Chromium
        run: pnpm exec playwright install --with-deps chromium

      - name: Generate Baselines
        run: pnpm exec playwright test e2e/tests --update-snapshots
        env:
          CI: true
          NEXT_PUBLIC_USE_MOCKS: 'true'
          NEXT_TELEMETRY_DISABLED: '1'
        continue-on-error: true

      - name: Count Generated Screenshots
        id: count
        run: |
          SCREENSHOT_COUNT=$(find e2e/__snapshots__ -name "*.png" 2>/dev/null | wc -l)
          echo "count=$SCREENSHOT_COUNT" >> $GITHUB_OUTPUT
          echo "ğŸ“¸ Generated $SCREENSHOT_COUNT baseline screenshots"

      - name: Generate Summary Report
        run: |
          echo "## ğŸ“¸ Visual Regression Baseline Generation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Screenshots Generated:** ${{ steps.count.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Platform-Agnostic Baselines" >> $GITHUB_STEP_SUMMARY
          echo "Generated baselines work on macOS, Linux, and Windows" >> $GITHUB_STEP_SUMMARY

      - name: Create PR with Baselines
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: 'chore: update visual regression baseline screenshots'
          branch: visual-baselines-${{ github.run_number }}
          delete-branch: true
          title: 'ğŸ“¸ Update Visual Regression Baselines'
          body: |
            ## ğŸ“¸ Baseline Screenshots Generated
            
            This PR contains automatically generated baseline screenshots for visual regression testing.
            
            ### Generation Details
            - **Source Branch:** ${{ github.event.inputs.branch }}
            - **Screenshots:** ${{ steps.count.outputs.count }} total
            - **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ### What's Included
            
            Platform-agnostic baseline screenshots for:
            - ğŸ“± **Mobile viewport:** 375Ã—667 (dynamically set via test fixtures)
            - ğŸ’» **Desktop viewport:** 1920Ã—1080 (dynamically set via test fixtures)
            - ğŸŒ **Browser:** Chromium
            - ğŸ­ **Mocked APIs:** All backend APIs mocked via MSW for consistency
            - ğŸ¨ **Component states:** Default, errors, filled forms, validation states
            - ğŸ–¥ï¸ **Platform:** Works on macOS, Linux, and Windows (uses pixel diff thresholds)
            
            ### Review Checklist
            
            Before merging, please verify:
            
            - [ ] Screenshot count is correct (~34 baselines expected)
            - [ ] Screenshots are clear and readable
            - [ ] Pages are fully loaded (no loading spinners)
            - [ ] Fonts are properly rendered
            - [ ] No unexpected scrollbars
            - [ ] Mobile screenshots show mobile layout (375px width)
            - [ ] Desktop screenshots show desktop layout (1920px width)
            
            ### Testing
            
            To verify these baselines work:
            
            ```bash
            # Checkout this PR branch
            gh pr checkout ${{ github.event.number }}
            
            # Run visual tests
            pnpm test:visual
            
            # All tests should pass
            ```
            
            ### Next Steps
            
            1. âœ… Review sample screenshots (see Files Changed)
            2. âœ… Verify quality meets standards
            3. âœ… Merge this PR
            4. âœ… Baselines are now updated
            
            ---
            
            **Generated by:** [Generate Visual Baselines Workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/generate-baselines.yml)
            **Triggered by:** @${{ github.actor }}
          labels: |
            visual-testing
            automated
            baselines
          reviewers: ${{ github.actor }}

      - name: Upload Baseline Artifacts
        if: always()
        uses: actions/upload-artifact@v4.5.0
        with:
          name: baseline-screenshots
          path: e2e/__snapshots__/
          retention-days: 30

      - name: Comment on Trigger Issue (if applicable)
        if: github.event.issue.number
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… Baseline Generation Complete
              
              **Screenshots generated:** ${{ steps.count.outputs.count }}
              **Branch:** ${{ github.event.inputs.branch }}
              
              A pull request has been created with the baseline screenshots.
              Please review and merge: #PR_NUMBER
              
              [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });
